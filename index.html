<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Verificamex - C√°mara Trasera</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .camera-info {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            font-size: 14px;
        }
        
        .camera-info p {
            margin: 5px 0;
        }
        
        .step-indicator {
            background: #6c757d;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .camera-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .camera-button {
            flex: 1;
            min-width: 140px;
        }
        
        .selfie-instruction {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .camera-buttons {
                flex-direction: column;
            }
            
            .camera-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Demo Verificamex</h1>
        <p class="warning">‚ö†Ô∏è SOLO PARA DESARROLLO - Token visible</p>
        
        <div class="camera-info">
            <p><strong>üì∏ Modo c√°mara trasera √∫nica:</strong></p>
            <p>‚Ä¢ Usamos solo la c√°mara trasera para todos los pasos</p>
            <p>‚Ä¢ Para selfie: apunta la c√°mara trasera hacia ti</p>
            <p>‚Ä¢ <span id="step-indicator">Paso 1 de 4</span></p>
        </div>
        
        <div class="debug-panel">
            <h3>üîß Controles de C√°mara</h3>
            <div class="debug-buttons">
                <button onclick="restartCamera()">üîÑ Reiniciar C√°mara</button>
                <button onclick="testSimpleEndpoint()">üîç Probar OCR</button>
                <button onclick="validateCURP('XEXX010101HNEXXXA4')">üìÑ Probar CURP</button>
                <button onclick="console.log('Fotos:', photos)">üìä Ver Fotos</button>
            </div>
        </div>
        
        <div class="steps">
            <!-- Paso 1: INE Frontal -->
            <div class="step active" id="step1">
                <h2>üìÑ Paso 1: INE Frontal</h2>
                <p><small>Apunta la c√°mara trasera al INE (frente)</small></p>
                
                <div class="camera-container">
                    <video id="video1" autoplay playsinline></video>
                    
                    <div class="camera-buttons">
                        <button onclick="capturePhoto(1)" class="camera-button" style="background: #28a745;">
                            üì∏ Capturar INE Frontal
                        </button>
                        <button onclick="useTestImage(1)" class="camera-button" style="background: #17a2b8;">
                            üß™ Usar Imagen de Prueba
                        </button>
                        <button onclick="skipStep(1)" class="camera-button" style="background: #6c757d;">
                            ‚è≠Ô∏è Saltar INE Frontal
                        </button>
                    </div>
                </div>
                
                <div class="preview" id="preview1"></div>
            </div>
            
            <!-- Paso 2: INE Trasero -->
            <div class="step" id="step2">
                <h2>üìÑ Paso 2: INE Trasero (Opcional)</h2>
                <p><small>Voltea el INE y captura la parte trasera</small></p>
                
                <div class="camera-container">
                    <video id="video2" autoplay playsinline></video>
                    
                    <div class="camera-buttons">
                        <button onclick="capturePhoto(2)" class="camera-button" style="background: #28a745;">
                            üì∏ Capturar INE Trasero
                        </button>
                        <button onclick="useTestImage(2)" class="camera-button" style="background: #17a2b8;">
                            üß™ Usar Imagen de Prueba
                        </button>
                        <button onclick="skipStep(2)" class="camera-button" style="background: #6c757d;">
                            ‚è≠Ô∏è Saltar INE Trasero
                        </button>
                    </div>
                </div>
                
                <div class="preview" id="preview2"></div>
            </div>
            
            <!-- Paso 3: Selfie -->
            <div class="step" id="step3">
                <h2>üòä Paso 3: Selfie (con c√°mara trasera)</h2>
                
                <div class="selfie-instruction">
                    <p><strong>üí° Instrucci√≥n para selfie:</strong></p>
                    <p>1. Voltea el tel√©fono (c√°mara trasera hacia ti)</p>
                    <p>2. Mira a la c√°mara trasera (puedes usar un espejo)</p>
                    <p>3. Toma la foto cuando est√©s listo</p>
                </div>
                
                <div class="camera-container">
                    <video id="video3" autoplay playsinline></video>
                    
                    <div class="camera-buttons">
                        <button onclick="capturePhoto(3)" class="camera-button" style="background: #28a745;">
                            üòä Capturar Selfie
                        </button>
                        <button onclick="useTestImage(3)" class="camera-button" style="background: #17a2b8;">
                            üß™ Usar Selfie de Prueba
                        </button>
                        <button onclick="skipStep(3)" class="camera-button" style="background: #6c757d;">
                            ‚è≠Ô∏è Saltar Selfie
                        </button>
                    </div>
                </div>
                
                <div class="preview" id="preview3"></div>
            </div>
            
            <!-- Paso 4: Validar -->
            <div class="step" id="step4">
                <h2>‚úÖ Paso 4: Validar</h2>
                <p><small>Env√≠a las fotos a Verificamex para validaci√≥n</small></p>
                
                <div class="camera-buttons">
                    <button onclick="validateIdentity()" class="validate-btn" style="background: #007bff;">
                        üöÄ Validar con Verificamex
                    </button>
                    <button onclick="tryComparison()" style="background: #ffc107; color: #000;">
                        üòä Solo Comparaci√≥n Facial
                    </button>
                    <button onclick="resetDemo()" style="background: #6c757d;">
                        üîÑ Comenzar de Nuevo
                    </button>
                </div>
                
                <div id="loading" style="display:none;">
                    <div class="spinner"></div>
                    <p>Procesando con Verificamex...</p>
                </div>
                
                <div id="result"></div>
            </div>
        </div>
        
        <div class="token-info">
            <small>üîê Token activo: <span id="token-preview">****************</span></small>
            <br>
            <small>üì∏ C√°mara: <span id="camera-status">Trasera</span></small>
            <br>
            <small>üîÑ √öltima acci√≥n: <span id="last-action">Iniciando...</span></small>
        </div>
    </div>
    
    <script src="camera.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Funci√≥n para probar endpoint simple (compatibilidad)
        function testSimpleEndpoint() {
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText('TEST', 20, 50);
            
            const testImage = canvas.toDataURL('image/jpeg', 0.5);
            
            fetch('https://api.verificamex.com/identity/v1/ocr/obverse', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${VERIFICAMEX_TOKEN}`
                },
                body: JSON.stringify({
                    ine_front: testImage
                })
            })
            .then(response => {
                console.log('Test status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Test response:', data);
                alert('‚úÖ OCR funciona! Ver consola para detalles.');
            })
            .catch(error => {
                console.error('Test error:', error);
                alert('‚ùå Error: ' + error.message);
            });
        }
        
        // Inicializaci√≥n cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar token parcial
            const tokenPreview = document.getElementById('token-preview');
            if (typeof VERIFICAMEX_TOKEN !== 'undefined' && VERIFICAMEX_TOKEN) {
                const visiblePart = VERIFICAMEX_TOKEN.substring(0, 10);
                tokenPreview.textContent = visiblePart + '...';
            }
            
            // Actualizar estado inicial
            updateCameraStatus('Trasera');
            updateLastAction('Iniciando...');
        });
        
        // Funciones de estado (llamadas desde camera.js)
        function updateCameraStatus(status) {
            const statusEl = document.getElementById('camera-status');
            if (statusEl) statusEl.textContent = status;
        }
        
        function updateLastAction(action) {
            const actionEl = document.getElementById('last-action');
            if (actionEl) actionEl.textContent = action;
        }
        
        function updateStepIndicator(step) {
            const indicator = document.getElementById('step-indicator');
            if (indicator) {
                indicator.textContent = `Paso ${step} de 4`;
            }
        }
    </script>
</body>
</html>